---
title: "cellmig: quantifying cell migration speed with hierarchical Bayesian models"
author: "Simo Kitanovski (simo.kitanovski@uni-due.de)"
output:
  BiocStyle::html_document
vignette: >
  %\VignetteIndexEntry{User Manual: cellmig}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r setup, include = FALSE, warning = FALSE}
knitr::opts_chunk$set(comment = FALSE, 
                      warning = FALSE, 
                      message = FALSE)
```


# Background

```{r}
library(cellmig)
library(ggplot2)
library(ggforce)
library(patchwork)
ggplot2::theme_set(new = theme_bw(base_size = 10))
```


# Data (raw)
In this vignette we will use simulated data: 
  
  * 6 compounds (chemical): c-1, c-2, ..., c-6
  * 5 doses: 1, 2, 3, 4 and 5
  * 3 sample: s-1, s-2 and s-3
  * 2 batches: b-1 and b-2

In each sample from a combination of compound x dose x batch, we have 
20 observations (cell velocities $v$)

```{r}
data("d_clean", package = "cellmig")
knitr::kable(d[1:10,], row.names = F, digits = 2)
```

```{r, fig.width=6, fig.height=4.5}
ggplot(data = d)+
  facet_wrap(facets = ~paste0(compound), scales = "free_y", ncol = 2)+
  geom_sina(aes(x = as.factor(dose), col = plate, y = v), size = 0.5)+
  theme_bw()+
  theme(legend.position = "top",
        strip.text.x = element_text(margin = margin(0.01,0,0.01,0, "cm")))+
  xlab(label = "dose")+
  scale_color_manual(values = c("steelblue", "orange", "forestgreen", "purple"))
```


# Migration speed (scaled)

```{r, fig.width=6, fig.height=4.5}
ggplot(data = d)+
  facet_wrap(facets = ~paste0(compound), scales = "free_y", ncol = 2)+
  geom_sina(aes(x = as.factor(dose), col = plate, y = v/max(v)), size = 0.5)+
  theme_bw()+
  theme(legend.position = "top",
        strip.text.x = element_text(margin = margin(0.01,0,0.01,0, "cm")))+
  xlab(label = "dose")+
  scale_color_manual(values = c("steelblue", "orange", "forestgreen", "purple"))
```


# Model

```{r, fig.width=7, fig.height=3.5}
o <- cellmig(x = d,
             model = "M",
             control = list(mcmc_warmup = 300,
                            mcmc_steps = 1300,
                            mcmc_chains = 4,
                            mcmc_cores = 4,
                            mcmc_algorithm = "NUTS",
                            adapt_delta = 0.8,
                            max_treedepth = 10))
```


# Compound:dose specific effects

```{r, fig.width=6, fig.height=3}
ggplot(data = o$s$mu_group)+
  geom_line(aes(x = dose, y = mean, col = compound, group = compound))+
  geom_point(aes(x = dose, y = mean, col = compound))+
  geom_errorbar(aes(x = dose, y = mean, ymin = X2.5., ymax = X97.5., 
                    col = compound), width = 0.04)
```



# Compound:dose profiles

```{r, fig.width=9, fig.height=5}
get_profiles(x = o)+
  patchwork::plot_layout(widths = c(1, 1, 5))
```




# Compare effects at specific doses
Huge differences in compound effects at dose = 2, 3 and 4. At dose = 1 and 
dose = 5, unclear differences in compound effects.

```{r, fig.width=6, fig.height=4}
u <- compare_doses(x = o)
u$pmax <- round(x = u$pmax, digits = 2)
u$M <- round(x = u$M, digits = 2)
```


## M

```{r, fig.width=6, fig.height=4}
ggplot(data = u)+
  facet_wrap(facets = ~paste0("dose=", dose))+
  geom_tile(aes(x = compound_i, y = compound_j, fill = M), col = "white")+
  geom_text(aes(x = compound_i, y = compound_j, label = M), 
            size = 3, col = "black")+
  scale_fill_distiller(name = "M", palette = "Spectral")
```


## $\pi$

```{r, fig.width=6, fig.height=4}
ggplot(data = u)+
  facet_wrap(facets = ~paste0("dose=", dose))+
  geom_tile(aes(x = compound_i, y = compound_j, fill = pmax), 
            col = "white")+
  geom_text(aes(x = compound_i, y = compound_j, label = pmax), 
            size = 3, col = "black")+
  scale_fill_distiller(name = expression(pi), 
                       palette = "Spectral", limits = c(0, 1))
```




# PPC

```{r, fig.width=5, fig.height=5}
g <- get_ppc(x = o)
g
```



# Session Info

```{r}
sessionInfo()
```

